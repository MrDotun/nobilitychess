<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Quest: The Wine Castle Siege</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <style>
        :root { --wine: #800000; --yellow: #FFD700; --dark-wine: #4a0000; }
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; padding-bottom: 50px; }
        
        /* Containers */
        #main-ui { display: flex; gap: 30px; margin-top: 20px; max-width: 1200px; }
        .panel { background: var(--wine); border: 3px solid var(--yellow); border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.7); }

        /* Timer & Character */
        #timer-wrap { width: 100%; height: 25px; background: var(--dark-wine); border: 2px solid var(--yellow); border-radius: 15px; margin-bottom: 15px; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ffae00, var(--yellow)); transition: width 1s linear; }
        #sir-tactics { width: 100px; transition: transform 0.3s; filter: drop-shadow(0 5px 5px black); }
        .level-up-anim { animation: celebrate 0.5s 3; filter: drop-shadow(0 0 20px var(--yellow)) !important; }
        @keyframes celebrate { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.3) rotate(5deg); } }

        /* Leaderboard & Hall */
        .leaderboard-table { width: 100%; border-collapse: collapse; color: var(--yellow); text-align: left; }
        .leaderboard-table th { border-bottom: 2px solid var(--yellow); padding: 10px; }
        .leaderboard-table td { padding: 12px 10px; font-weight: bold; border-bottom: 1px solid rgba(255,215,0,0.1); }
        .legend-badge { background: var(--dark-wine); border: 1px solid var(--yellow); padding: 10px; border-radius: 8px; text-align: center; min-width: 120px; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal { background: var(--wine); border: 5px solid var(--yellow); padding: 40px; border-radius: 20px; max-width: 600px; text-align: center; }
        
        /* Buttons */
        .btn { background: var(--yellow); color: var(--wine); border: none; padding: 12px 25px; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 1.1rem; text-transform: uppercase; }
        .btn:hover { background: #e6c200; transform: translateY(-2px); }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; margin: 5px; }

        /* Click-to-move highlights */
        .highlight-yellow { box-shadow: inset 0 0 3px 3px yellow; }
    </style>
</head>
<body>

<div id="login-screen" class="overlay">
    <div class="modal">
        <h1 style="color: var(--yellow); font-size: 2.5rem; margin-top: 0;">‚öîÔ∏è WINE CASTLE SIEGE ‚öîÔ∏è</h1>
        <p>Enter your Knight Name to join the Royal Guard</p>
        <input type="text" id="playerName" placeholder="Knight Name..." style="padding: 15px; width: 80%; border-radius: 8px; border: none; font-size: 1.2rem; margin-bottom: 20px;">
        <br>
        <button class="btn" onclick="showHandbook()">ENTER CASTLE</button>
    </div>
</div>

<div id="handbook-overlay" class="overlay" style="display:none;">
    <div class="modal" style="text-align: left;">
        <h2 style="text-align: center; color: var(--yellow);">üìú THE KNIGHT'S HANDBOOK</h2>
        <ul>
            <li><strong>The Mission:</strong> Solve puzzles to breach the gates. Click a piece, then click a square to move.</li>
            <li><strong>The Timer:</strong> You have 5 minutes. Speed is vital!</li>
            <li><strong>The Streak:</strong> Solve 3 in a row to Level Up Sir Tactics.</li>
            <li><strong>The Glory:</strong> Top 3 earn the Royal Decree.</li>
        </ul>
        <div style="text-align:center;">
            <button class="btn" onclick="startQuest()">I ACCEPT THE QUEST!</button>
        </div>
    </div>
</div>

<div id="main-ui">
    <div style="flex: 2;">
        <div id="timer-wrap"><div id="timer-bar"></div></div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <img id="sir-tactics" src="http://googleusercontent.com/image_collection/image_retrieval/9101552310892581841_0" alt="Sir Tactics">
            <div id="streak-ui" style="color: var(--yellow); font-size: 1.5rem; font-weight: bold;">Streak: 0 ‚≠ê</div>
        </div>
        <div id="board" style="width: 500px;"></div>
        <h2 id="status-msg" style="text-align: center; color: var(--yellow); min-height: 40px;">Ready your move, Knight!</h2>
    </div>

    <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
        <div class="panel">
            <h3 style="margin-top:0; text-align: center; color: var(--yellow);">üèÜ TOP 3 KNIGHTS</h3>
            <table class="leaderboard-table">
                <thead><tr><th>#</th><th>Knight</th><th>Stars</th></tr></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
            <button class="btn" style="width:100%; margin-top:15px; font-size: 0.9rem;" onclick="generateCertificate()">üñ®Ô∏è PRINT MY DECREE</button>
        </div>
        
        <div class="panel">
            <h3 style="margin-top:0; text-align: center; color: var(--yellow);">üèõÔ∏è HALL OF FAME</h3>
            <div id="hall-of-fame-list" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
        </div>
    </div>
</div>

<div style="margin-top: 40px; opacity: 0.6;">
    <button class="btn btn-small" style="background: #444; color: white;" onclick="resetDaily()">Coach: Reset Daily Class</button>
    <button class="btn btn-small" style="background: #444; color: #ff6666;" onclick="fullReset()">Full Factory Reset</button>
</div>

<div id="cert-template" style="display:none;">
    <div style="width: 800px; height: 550px; padding: 40px; border: 15px double #FFD700; background: #800000; color: #FFD700; text-align: center; font-family: serif;">
        <h1 style="font-size: 50px; margin-bottom: 10px;">ROYAL DECREE</h1>
        <p style="font-size: 20px;">The High Council of Chess hereby honors</p>
        <h2 style="font-size: 45px; border-bottom: 3px solid #FFD700; display: inline-block; padding: 0 30px;">{{NAME}}</h2>
        <p style="font-size: 22px;">For showing elite Tactical Mastery during the Siege of Wine Castle.</p>
        <div style="margin-top: 60px; display: flex; justify-content: space-around; align-items: center;">
            <div><p>____________________</p><p>Coach Adekunle Busayo</p></div>
            <div style="font-size: 60px;">üõ°Ô∏è</div>
            <div><p>____________________</p><p>Date of Victory</p></div>
        </div>
    </div>
</div>

<script>
    // --- DATABASE ---
    const puzzles = [
        { fen: 'r1bqkb1r/pp2p1pp/1np5/8/4P3/1BN2N2/PPP2PPP/R1BQK2R w KQkq - 0 1', solution: 'Bf7+' },
        { fen: '1k6/ppp5/8/1n4Q1/P7/6P1/b3PPK1/8 w - - 0 1', solution: 'Qd8#' },
        { fen: '2r4k/p1R4p/1p3N2/4n3/8/6P1/5PK1/8 w - - 0 1', solution: 'Rh7#' },
        { fen: 'r4rkR/ppN2p1p/2p3p1/6Q1/8/1B4P1/PPP2P1P/6K1 w - - 0 1', solution: 'Qxg6+' },
        { fen: '5bnr/R5pk/4p2p/5N2/4Q2n/rPq3P1/P3PPK1/8 w - - 0 1', solution: 'Nh4#' }
    ];

    // --- GAME STATE ---
    let game = new Chess();
    let board = null;
    let currentIdx = 0;
    let streak = 0;
    let timeLeft = 300;
    let timerInterval = null;
    let players = JSON.parse(localStorage.getItem('chessQuestPlayers')) || [];
    let legends = JSON.parse(localStorage.getItem('chessQuestLegends')) || [];
    let currentPlayer = null;

    // --- SOUNDS ---
    const sndCorrect = new Audio('https://actions.google.com/sounds/v1/cartoon/clank_and_rattle.ogg');
    const sndLevelUp = new Audio('https://actions.google.com/sounds/v1/foley/beeps_and_clicks.ogg');

    // --- FUNCTIONS ---
    function showHandbook() {
        const name = document.getElementById('playerName').value.trim();
        if (!name) return alert("Identify yourself, Knight!");
        currentPlayer = players.find(p => p.name === name) || { name: name, stars: 0 };
        if (!players.includes(currentPlayer)) players.push(currentPlayer);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('handbook-overlay').style.display = 'flex';
        updateLeaderboard();
        updateHallOfFame();
    }

    function startQuest() {
        document.getElementById('handbook-overlay').style.display = 'none';
        initBoard();
        startTimer();
    }

    function initBoard() {
        game.load(puzzles[currentIdx].fen);
        board = Chessboard('board', {
            draggable: true,
            position: puzzles[currentIdx].fen,
            onDrop: handleMove,
            onSnapEnd: () => board.position(game.fen())
        });
    }

    function handleMove(source, target) {
        let move = game.move({ from: source, to: target, promotion: 'q' });
        if (move === null) return 'snapback';

        if (move.san === puzzles[currentIdx].solution) {
            streak++;
            currentPlayer.stars += 10;
            sndCorrect.play();
            document.getElementById('status-msg').innerHTML = "<span style='color:#00ff00'>‚úÖ BRILLIANT!</span>";
            
            if (streak % 3 === 0) {
                sndLevelUp.play();
                document.getElementById('sir-tactics').classList.add('level-up-anim');
                setTimeout(() => document.getElementById('sir-tactics').classList.remove('level-up-anim'), 2000);
            }
            
            saveData();
            setTimeout(nextPuzzle, 1000);
        } else {
            streak = 0;
            document.getElementById('status-msg').innerHTML = "<span style='color:#ff4444'>‚ùå THE GATE HOLDS!</span>";
            game.undo();
            return 'snapback';
        }
        document.getElementById('streak-ui').innerText = `Streak: ${streak} ‚≠ê`;
    }

    function nextPuzzle() {
        currentIdx++;
        if (currentIdx >= puzzles.length) {
            alert("CASTLE CONQUERED! You are a Grandmaster Knight!");
            checkHallOfFame();
            location.reload();
            return;
        }
        game.load(puzzles[currentIdx].fen);
        board.position(puzzles[currentIdx].fen);
        document.getElementById('status-msg').innerText = "Next gate ahead...";
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer-bar').style.width = (timeLeft / 300 * 100) + "%";
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("TIME EXPIRED! The castle gates are locked.");
                checkHallOfFame();
                location.reload();
            }
        }, 1000);
    }

    function saveData() {
        localStorage.setItem('chessQuestPlayers', JSON.stringify(players));
        updateLeaderboard();
    }

    function updateLeaderboard() {
        const sorted = [...players].sort((a, b) => b.stars - a.stars).slice(0, 3);
        const html = sorted.map((p, i) => `<tr><td>${['ü•á','ü•à','ü•â'][i]}</td><td>${p.name}</td><td>${p.stars}</td></tr>`).join('');
        document.getElementById('leaderboard-body').innerHTML = html;
    }

    function checkHallOfFame() {
        const topPlayer = [...players].sort((a, b) => b.stars - a.stars)[0];
        if (topPlayer && !legends.find(l => l.name === topPlayer.name)) {
            legends.push({ name: topPlayer.name, date: new Date().toLocaleDateString() });
            localStorage.setItem('chessQuestLegends', JSON.stringify(legends));
        }
    }

    function updateHallOfFame() {
        document.getElementById('hall-of-fame-list').innerHTML = legends.map(l => 
            `<div class="legend-badge">üëë<br>${l.name}</div>`
        ).join('');
    }

    function generateCertificate() {
        const topThree = [...players].sort((a, b) => b.stars - a.stars).slice(0, 3).map(p => p.name);
        if (!topThree.includes(currentPlayer.name)) return alert("Only the Top 3 Knights can claim a Decree!");
        
        let html = document.getElementById('cert-template').innerHTML.replace('{{NAME}}', currentPlayer.name);
        const win = window.open('', '', 'width=900,height=600');
        win.document.write(`<html><body style="margin:0; background:#222; display:flex; justify-content:center; align-items:center; height:100vh;">${html}</body></html>`);
        setTimeout(() => { win.print(); }, 500);
    }

    function resetDaily() {
        if(confirm("Coach, clear daily scores? (Hall of Fame will stay!)")) {
            localStorage.setItem('chessQuestPlayers', JSON.stringify([]));
            location.reload();
        }
    }

    function fullReset() {
        if(confirm("Wipe EVERYTHING?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
